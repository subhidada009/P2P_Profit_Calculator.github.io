<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>P2P Profit Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <style>
         :root {
            --bg-primary: #0f0d0b;
            --bg-container: #121212;
            --bg-header: #1e1e1e;
            --bg-row: #1e1e1e;
            --bg-form: #1e1e1e;
            --text-primary: #FFD36E;
            --text-secondary: #FFFFFF;
            --text-muted: #C7D2A8;
            --btn-bg: #2b2b2b;
            --btn-hover: #3a3a3a;
            --btn-active: #FFD36E;
            --border-color: #333;
            --shadow: rgba(255, 211, 110, 0.1);
            --manual-bg: #2e4c2e;
            --manual-border: #4CAF50;
            --manual-text: #C8E6C9;
            --accent: #FFD36E;
            --card-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .light-theme {
            --bg-primary: #ffffff;
            --bg-container: #fafafa;
            --bg-header: #f7f7f7;
            --bg-row: #ffffff;
            --bg-form: #f9f9f9;
            --text-primary: #000000;
            --text-secondary: #000000;
            --text-muted: #444444;
            --btn-bg: #f5f5f5;
            --btn-hover: #e6e6e6;
            --btn-active: #f0b90b;
            --border-color: #eaecef;
            --shadow: rgba(0, 0, 0, 0.06);
            --manual-bg: #fff9e6;
            --manual-border: #f0b90b;
            --manual-text: #000000;
            --accent: #f0b90b;
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-secondary);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.4s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-container);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .title {
            font-size: 30px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }
        
        .top-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-header);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .btn {
            background: var(--btn-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 9px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn:hover {
            background: var(--btn-hover);
        }
        
        .btn.active {
            background: var(--btn-active);
            color: #000;
            border-color: var(--btn-active);
        }
        
        .btn i {
            font-size: 14px;
        }
        
        select.currency-select,
        .currency-input,
        .manual-trade-form input,
        .manual-trade-form select {
            background: var(--btn-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            min-width: 110px;
            outline: none;
        }
        
        .currency-input {
            width: 150px;
        }
        
        .table-container {
            background: var(--bg-container);
            border-radius: 8px;
            padding: 18px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        /* تصغير خط عمود Order No. */
        
        .trade-row .col-number {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
        }
        
        .table-header {
            display: flex;
            background: var(--bg-header);
            color: var(--text-primary);
            font-weight: 600;
            padding: 12px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .table-header>div {
            text-align: center;
        }
        
        .trade-row {
            display: flex;
            background: var(--bg-row);
            margin: 6px 0;
            padding: 12px;
            border-radius: 6px;
            align-items: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .trade-row:hover {
            background: var(--btn-hover);
            border-color: var(--accent);
        }
        
        .trade-row.manual-trade {
            background: var(--manual-bg);
            border: 1px solid var(--manual-border);
        }
        
        .trade-row.manual-trade .order,
        .trade-row.manual-trade .price,
        .trade-row.manual-trade .profit {
            color: var(--manual-text) !important;
        }
        
        .trade-row>div {
            text-align: center;
            color: var(--text-secondary);
        }
        
        .trade-row .order {
            color: var(--text-muted);
        }
        
        .trade-row .price,
        .trade-row .profit {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .delete-btn {
            background: #f6465d;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .delete-btn:hover {
            background: #d63041;
        }
        
        .col-id {
            width: 5%;
        }
        
        .col-time {
            width: 13%;
        }
        
        .col-order {
            width: 14%;
        }
        
        .col-price {
            width: 10%;
        }
        
        .col-profit {
            width: 10%;
        }
        
        .col-number {
            width: 13%;
        }
        
        .col-counter {
            width: 18%;
        }
        
        .col-delete {
            width: 7%;
        }
        
        .manual-trade-form {
            margin: 25px 0;
            padding: 20px;
            background: var(--bg-form);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: center;
        }
        
        .manual-trade-form label {
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            min-width: 70px;
            text-align: right;
        }
        
        .btn-add-manual {
            background: var(--btn-active) !important;
            font-weight: bold;
            color: black !important;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
        }
        
        .btn-add-manual:hover {
            background: #d9a60a !important;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-top: 25px;
        }
        
        .result-card {
            background: var(--bg-container);
            padding: 14px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease;
        }
        
        .result-card:hover {
            transform: translateY(-3px);
        }
        
        .result-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .result-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 4px;
        }
        
        .results-grid.bottom {
            margin-top: 10px;
            grid-template-columns: repeat(2, 1fr);
        }
        
        @media (max-width: 1000px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            .top-bar {
                flex-direction: column;
            }
            .container {
                padding: 15px;
            }
            .title {
                font-size: 24px;
            }
        }
        
        @media print {
            body {
                background: white !important;
                color: black !important;
                padding: 10px;
            }
            .container,
            .result-card,
            .table-container {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }
            .btn,
            .top-bar,
            .manual-trade-form {
                display: none !important;
            }
            .result-value,
            .result-label {
                color: black !important;
            }
            .trade-row {
                background: white !important;
                color: black !important;
                border: 1px solid #eee !important;
            }
            .trade-row .price,
            .trade-row .profit {
                color: #d35400 !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 class="title" id="title">P2P Profit Calculator</h1>
        </div>
        <div class="top-bar">
            <button id="loadFile" class="btn">📂 Load File</button>
            <button id="refresh" class="btn">🔄 Refresh</button>
            <button id="printResults" class="btn">🖨️ Print Results</button>
            <input type="number" id="marketPrice" class="currency-input" placeholder="Market Price" step="0.0001">
            <select id="assetCurrency" class="currency-select">
                <option value="USDT">USDT</option>
                <option value="BUSD">BUSD</option>
                <option value="BTC">BTC</option>
                <option value="ETH">ETH</option>
                <option value="BNB">BNB</option>
                <option value="ADA">ADA</option>
                <option value="XRP">XRP</option>
                <option value="SOL">SOL</option>
                <option value="DOT">DOT</option>
                <option value="MATIC">MATIC</option>
                <option value="LTC">LTC</option>
                <option value="DOGE">DOGE</option>
                <option value="SHIB">SHIB</option>
                <option value="TRX">TRX</option>
                <option value="USDC">USDC</option>
                <option value="TON">TON</option>
            </select>
            <span style="color:var(--text-primary); margin: 0 5px;">/</span>
            <select id="fiatCurrency" class="currency-select"></select>
            <button id="showAll" class="btn active">All Trades</button>
            <button id="showBuys" class="btn">Buys</button>
            <button id="showSells" class="btn">Sells</button>
            <button id="toggleSearch" class="btn">🔍 بحث</button>
            <input type="text" id="searchOrderNo" class="currency-input" placeholder="ابحث برقم الطلب..." style="display: none; margin: 0 10px;" />
            <select id="language" class="btn">
                <option value="en">English</option>
                <option value="ar">العربية</option>
                <option value="fr">Français</option>
                <option value="de">Deutsch</option>
                <option value="es">Español</option>
                <option value="ru">Русский</option>
                <option value="tr">Türkçe</option>
            </select>
            <button id="themeToggle" class="btn">🌙 Dark Mode</button>
        </div>
        <div class="manual-trade-form">
            <label for="manualOrderType">Type</label>
            <select id="manualOrderType">
                <option value="buy">Buy</option>
                <option value="sell">Sell</option>
            </select>
            <input type="number" id="manualPrice" placeholder="Price" step="0.0001">
            <input type="number" id="manualQty" placeholder="Quantity" step="0.0001">
            <input type="text" id="manualCounterparty" placeholder="Counterparty">
            <input type="text" id="manualOrderNo" placeholder="Order No.">
            <input type="text" id="manualTime" placeholder="Time (e.g. 2025-08-22 14:36:27)">
            <button id="addManualTrade" class="btn">➕ Add Manual</button>
        </div>
        <div class="table-container">
            <div class="table-header">
                <div class="col-id sortable" data-sort="id">ID</div>
                <div class="col-time sortable" data-sort="time">Time</div>
                <div class="col-order sortable" data-sort="order">Order</div>
                <div class="col-price sortable" data-sort="price">Price</div>
                <div class="col-profit sortable" data-sort="profit">Profit</div>
                <div class="col-number sortable" data-sort="orderNo">Order No.</div>
                <div class="col-counter sortable" data-sort="counterparty">Counterparty</div>
                <div class="col-delete">Delete</div>
            </div>
            <div class="table-body" id="tableBody"></div>
        </div>
        <div class="results-grid" id="resultsGrid"></div>
        <div class="results-grid bottom">
            <div class="result-card">
                <div class="result-label" id="labelLastSold">Last Sold Price</div>
                <div class="result-value" id="lastSoldPrice">—</div>
            </div>
            <div class="result-card">
                <div class="result-label" id="labelAvgBuy">Avg Buy Price (Remaining)</div>
                <div class="result-value" id="avgBuyPrice">—</div>
            </div>
        </div>
    </div>
    <script>
        // === الترجمات الكاملة ===
        const translations = {
            ar: {
                labels: ["إجمالي الربح/الخسارة", "إجمالي المشتريات", "إجمالي المبيعات", "إجمالي العمولات", "صافي الربح بعد العمولات", "صفقات شراء", "صفقات بيع", "إجمالي الكمية المتبقية", "تكلفة شراء المتبقي", "قيمته بسعر السوق", "الربح/الخسارة غير المحققة"],
                headers: ["الرقم", "تاريخ", "العملية", "السعر", "الربح", "رقم المعاملة", "اسم الزبون", "حذف"],
                all: "كل الصفقات",
                buys: "الشراء",
                sells: "البيع",
                title: "حاسبة الأرباح P2P",
                marketPrice: "سعر السوق",
                lastSold: "آخر سعر بيع",
                avgBuy: "متوسط سعر الشراء",
                print: "طباعة النتائج",
                addManual: "إضافة يدوية",
                refresh: "تحديث",
                search: "بحث",
                close: "إغلاق",
                searchPlaceholder: "ابحث برقم الطلب...",
                currencies: {
                    USD: "دولار أمريكي",
                    EUR: "يورو",
                    GBP: "باوند إنجليزي",
                    AED: "درهم إماراتي",
                    SAR: "ريال سعودي",
                    QAR: "ريال قطري",
                    KWD: "دينار كويتي",
                    OMR: "ريال عماني",
                    JOD: "دينار أردني",
                    EGP: "جنيه مصري",
                    MAD: "درهم مغربي",
                    TRY: "ليرة تركية (TL)",
                    UAH: "هريفنيا أوكرانية",
                    RUB: "روبل روسي",
                    IDR: "روبية إندونيسية",
                    INR: "روبية هندية",
                    NGN: "نايرا نيجيري",
                    ZAR: "راند جنوب أفريقي",
                    PHP: "بيزو فلبيني",
                    THB: "บาท تايلندي",
                    CNY: "يوان صيني",
                    JPY: "ين ياباني",
                    KRW: "وون كوري",
                    PKR: "روبية باكستانية",
                    BRL: "ريال برازيلي",
                    AUD: "دولار أسترالي",
                    CAD: "دولار كندي"
                }
            },
            en: {
                labels: ["Total Profit/Loss", "Total Buys", "Total Sells", "Total Fees", "Net Profit After Fees", "Buy Trades", "Sell Trades", "Remaining Quantity", "Remaining Cost", "Market Value", "Unrealized Profit/Loss"],
                headers: ["ID", "Time", "Order", "Price", "Profit", "Order No.", "Counterparty", "Delete"],
                all: "All Trades",
                buys: "Buys",
                sells: "Sells",
                title: "P2P Profit Calculator",
                marketPrice: "Market Price",
                lastSold: "Last Sold Price",
                avgBuy: "Avg Buy Price (Remaining)",
                print: "Print Results",
                addManual: "Add Manual",
                refresh: "Refresh",
                search: "Search",
                close: "Close",
                searchPlaceholder: "Search by Order No...",
                currencies: {
                    USD: "USD",
                    EUR: "EUR",
                    GBP: "GBP",
                    AED: "AED",
                    SAR: "SAR",
                    QAR: "QAR",
                    KWD: "KWD",
                    OMR: "OMR",
                    JOD: "JOD",
                    EGP: "EGP",
                    MAD: "MAD",
                    TRY: "TRY (TL)",
                    UAH: "UAH",
                    RUB: "RUB",
                    IDR: "IDR",
                    INR: "INR",
                    NGN: "NGN",
                    ZAR: "ZAR",
                    PHP: "PHP",
                    THB: "THB",
                    CNY: "CNY",
                    JPY: "JPY",
                    KRW: "KRW",
                    PKR: "PKR",
                    BRL: "BRL",
                    AUD: "AUD",
                    CAD: "CAD"
                }
            },
            fr: {
                labels: ["Profit/Perte Total", "Achats Totals", "Ventes Totales", "Frais Totaux", "Profit Net après Frais", "Transactions d'Achat", "Transactions de Vente", "Quantité Restante", "Coût Restant", "Valeur de Marché", "Profit/Perte Non Réalisé"],
                headers: ["ID", "Heure", "Ordre", "Prix", "Profit", "N° d'ordre", "Contrepartie", "Suppr."],
                all: "Toutes",
                buys: "Achats",
                sells: "Ventes",
                title: "Calculateur P2P",
                marketPrice: "Prix du marché",
                lastSold: "Dernier prix de vente",
                avgBuy: "Prix d'achat moyen",
                print: "Imprimer les résultats",
                addManual: "Ajouter manuellement",
                refresh: "Actualiser",
                search: "Rechercher",
                close: "Fermer",
                searchPlaceholder: "Rechercher par N° d'ordre...",
                currencies: {
                    USD: "USD - Dollar Américain",
                    EUR: "EUR - Euro",
                    GBP: "GBP - Livre Sterling",
                    AED: "AED - Dirham des Émirats",
                    SAR: "SAR - Riyal Saoudien",
                    QAR: "QAR - Riyal Qatari",
                    KWD: "KWD - Dinar Koweïtien",
                    OMR: "OMR - Rial Omanais",
                    JOD: "JOD - Dinar Jordanien",
                    EGP: "EGP - Livre Égyptienne",
                    MAD: "MAD - Dirham Marocain",
                    TRY: "TRY - Livre Turque (TL)",
                    UAH: "UAH - Hryvnia Ukrainienne",
                    RUB: "RUB - Rouble Russe",
                    IDR: "IDR - Rupiah Indonésienne",
                    INR: "INR - Roupie Indienne",
                    NGN: "NGN - Naira Nigériane",
                    ZAR: "ZAR - Rand Sud-Africain",
                    PHP: "PHP - Peso Philippin",
                    THB: "THB - Baht Thaïlandais",
                    CNY: "CNY - Yuan Chinois",
                    JPY: "JPY - Yen Japonais",
                    KRW: "KRW - Won Coréen",
                    PKR: "PKR - Roupie Pakistanaise",
                    BRL: "BRL - Réal Brésilien",
                    AUD: "AUD - Dollar Australien",
                    CAD: "CAD - Dollar Canadien"
                }
            },
            de: {
                labels: ["Gesamtgewinn/-verlust", "Gesamte Käufe", "Gesamte Verkäufe", "Gesamte Gebühren", "Nettogewinn nach Gebühren", "Kauftransaktionen", "Verkaufstransaktionen", "Verbleibende Menge", "Verbleibende Kosten", "Marktwert", "Unrealisierter Gewinn/Verlust"],
                headers: ["ID", "Zeit", "Order", "Preis", "Gewinn", "Order-Nr.", "Gegenpartei", "Löschen"],
                all: "Alle Trades",
                buys: "Käufe",
                sells: "Verkäufe",
                title: "P2P Gewinnrechner",
                marketPrice: "Marktpreis",
                lastSold: "Letzter Verkaufspreis",
                avgBuy: "Durchschnittlicher Kaufpreis",
                print: "Ergebnisse drucken",
                addManual: "Manuell hinzufügen",
                refresh: "Aktualisieren",
                search: "Suche",
                close: "Schließen",
                searchPlaceholder: "Nach Bestellnummer suchen...",
                currencies: {
                    USD: "USD - US-Dollar",
                    EUR: "EUR - Euro",
                    GBP: "GBP - Britisches Pfund",
                    AED: "AED - Dirham der Vereinigten Arabischen Emirate",
                    SAR: "SAR - Saudischer Riyal",
                    QAR: "QAR - Katar-Riyal",
                    KWD: "KWD - Kuwait-Dinar",
                    OMR: "OMR - Oman-Rial",
                    JOD: "JOD - Jordanischer Dinar",
                    EGP: "EGP - Ägyptisches Pfund",
                    MAD: "MAD - Marokkanischer Dirham",
                    TRY: "TRY - Türkische Lira (TL)",
                    UAH: "UAH - Ukrainische Hrywnja",
                    RUB: "RUB - Russischer Rubel",
                    IDR: "IDR - Indonesische Rupiah",
                    INR: "INR - Indische Rupie",
                    NGN: "NGN - Naira",
                    ZAR: "ZAR - Südafrikanischer Rand",
                    PHP: "PHP - Philippinischer Peso",
                    THB: "THB - Thailändischer Baht",
                    CNY: "CNY - Chinesischer Yuan",
                    JPY: "JPY - Japanischer Yen",
                    KRW: "KRW - Südkoreanischer Won",
                    PKR: "PKR - Pakistanische Rupie",
                    BRL: "BRL - Brasilianischer Real",
                    AUD: "AUD - Australischer Dollar",
                    CAD: "CAD - Kanadischer Dollar"
                }
            },
            es: {
                labels: ["Beneficio/Pérdida Total", "Compras Totales", "Ventas Totales", "Comisiones Totales", "Beneficio Neto tras Comisiones", "Operaciones de Compra", "Operaciones de Venta", "Cantidad Restante", "Costo Restante", "Valor de Mercado", "Beneficio/Pérdida No Realizado"],
                headers: ["ID", "Hora", "Orden", "Precio", "Ganancia", "N.º Orden", "Contraparte", "Eliminar"],
                all: "Todas",
                buys: "Compras",
                sells: "Ventas",
                title: "Calculadora P2P",
                marketPrice: "Precio de mercado",
                lastSold: "Último precio de venta",
                avgBuy: "Precio medio de compra",
                print: "Imprimir resultados",
                addManual: "Añadir manualmente",
                refresh: "Actualizar",
                search: "Buscar",
                close: "Cerrar",
                searchPlaceholder: "Buscar por número de pedido...",
                currencies: {
                    USD: "USD - Dólar estadounidense",
                    EUR: "EUR - Euro",
                    GBP: "GBP - Libra esterlina",
                    AED: "AED - Dirham de los Emiratos Árabes Unidos",
                    SAR: "SAR - Riyal saudí",
                    QAR: "QAR - Riyal catarí",
                    KWD: "KWD - Dinar kuwaití",
                    OMR: "OMR - Rial omaní",
                    JOD: "JOD - Dinar jordano",
                    EGP: "EGP - Libra egipcia",
                    MAD: "MAD - Dirham marroquí",
                    TRY: "TRY - Lira turca (TL)",
                    UAH: "UAH - Grivna ucraniana",
                    RUB: "RUB - Rublo ruso",
                    IDR: "IDR - Rupia indonesia",
                    INR: "INR - Rupia india",
                    NGN: "NGN - Naira nigeriana",
                    ZAR: "ZAR - Rand sudafricano",
                    PHP: "PHP - Peso filipino",
                    THB: "THB - Baht tailandés",
                    CNY: "CNY - Yuan chino",
                    JPY: "JPY - Yen japonés",
                    KRW: "KRW - Won surcoreano",
                    PKR: "PKR - Rupia pakistaní",
                    BRL: "BRL - Real brasileño",
                    AUD: "AUD - Dólar australiano",
                    CAD: "CAD - Dólar canadiense"
                }
            },
            ru: {
                labels: ["Общая прибыль/убыток", "Всего покупок", "Всего продаж", "Общая комиссия", "Чистая прибыль после комиссий", "Сделок купли", "Сделок продажи", "Оставшееся количество", "Остаточная стоимость", "Рыночная стоимость", "Нереализованная прибыль/убыток"],
                headers: ["ID", "Время", "Ордер", "Цена", "Профит", "Номер", "Контрагент", "Удалить"],
                all: "Все сделки",
                buys: "Покупки",
                sells: "Продажи",
                title: "P2P Калькулятор",
                marketPrice: "Рыночная цена",
                lastSold: "Последняя цена продажи",
                avgBuy: "Средняя цена покупки",
                print: "Распечатать результаты",
                addManual: "Добавить вручную",
                refresh: "Обновить",
                search: "Поиск",
                close: "Закрыть",
                searchPlaceholder: "Поиск по номеру заказа...",
                currencies: {
                    USD: "USD - Доллар США",
                    EUR: "EUR - Евро",
                    GBP: "GBP - Фунт стерлингов",
                    AED: "AED - Дирхам ОАЭ",
                    SAR: "SAR - Саудовский риял",
                    QAR: "QAR - Катарский риял",
                    KWD: "KWD - Кувейтский динар",
                    OMR: "OMR - Оманский риал",
                    JOD: "JOD - Иорданский динар",
                    EGP: "EGP - Египетский фунт",
                    MAD: "MAD - Марокканский дирхам",
                    TRY: "TRY - Турецкая лира (TL)",
                    UAH: "UAH - Украинская гривна",
                    RUB: "RUB - Российский рубль",
                    IDR: "IDR - Индонезийская рупия",
                    INR: "INR - Индийская рупия",
                    NGN: "NGN - Нигерийская найра",
                    ZAR: "ZAR - Южноафриканский рэнд",
                    PHP: "PHP - Филиппинский песо",
                    THB: "THB - Тайский бат",
                    CNY: "CNY - Китайский юань",
                    JPY: "JPY - Японская иена",
                    KRW: "KRW - Южнокорейская вона",
                    PKR: "PKR - Пакистанская рупия",
                    BRL: "BRL - Бразильский реал",
                    AUD: "AUD - Австралийский доллар",
                    CAD: "CAD - Канадский доллар"
                }
            },
            tr: {
                labels: ["Toplam Kar/Zarar", "Toplam Alım", "Toplam Satış", "Toplam Ücret", "Ücretler Sonrası Net Kar", "Alım İşlemleri", "Satış İşlemleri", "Kalan Miktar", "Kalan Maliyet", "Piyasa Değeri", "Gerçekleşmemiş Kar/Zarar"],
                headers: ["ID", "Zaman", "Emir", "Fiyat", "Kâr", "Sipariş No", "Karşı Taraf", "Sil"],
                all: "Tümü",
                buys: "Alımlar",
                sells: "Satışlar",
                title: "P2P Kâr Hesaplayıcı",
                marketPrice: "Piyasa Fiyatı",
                lastSold: "Son Satış Fiyatı",
                avgBuy: "Ortalama Alış Fiyatı",
                print: "Sonuçları Yazdır",
                addManual: "Manuel Ekle",
                refresh: "Yenile",
                search: "Ara",
                close: "Kapat",
                searchPlaceholder: "Sipariş No'ya göre ara...",
                currencies: {
                    USD: "USD - Amerikan Doları",
                    EUR: "EUR - Euro",
                    GBP: "GBP - İngiliz Sterlini",
                    AED: "AED - Birleşik Arap Emirlikleri Dirhemi",
                    SAR: "SAR - Suudi Riyali",
                    QAR: "QAR - Katar Riyali",
                    KWD: "KWD - Kuveyt Dinarı",
                    OMR: "OMR - Umman Riyali",
                    JOD: "JOD - Ürdün Dinarı",
                    EGP: "EGP - Mısır Libresi",
                    MAD: "MAD - Fas Dirhemi",
                    TRY: "TL - Türk Lirası",
                    UAH: "UAH - Ukrayna Grivnası",
                    RUB: "RUB - Rus Rublesi",
                    IDR: "IDR - Endonezya Rupisi",
                    INR: "INR - Hindistan Rupisi",
                    NGN: "NGN - Nijerya Nairası",
                    ZAR: "ZAR - Güney Afrika Randı",
                    PHP: "PHP - Filipin Pezosu",
                    THB: "THB - Tayland Bahtı",
                    CNY: "CNY - Çin Yuani",
                    JPY: "JPY - Japon Yeni",
                    KRW: "KRW - Güney Kore Wonu",
                    PKR: "PKR - Pakistan Rupisi",
                    BRL: "BRL - Brezilya Reali",
                    AUD: "AUD - Avustralya Doları",
                    CAD: "CAD - Kanada Doları"
                }
            }
        };

        // === التهيئة بعد تحميل الصفحة ===
        document.addEventListener("DOMContentLoaded", function() {
            let LANG = "en";
            let originalData = [];
            let tradeList = [];
            let summaryValues = Array(11).fill("0.00");
            let viewMode = "all";
            let sortKey = null;
            let sortDirection = 1;

            const assetCurrencySelect = document.getElementById("assetCurrency");
            const fiatCurrencySelect = document.getElementById("fiatCurrency");
            const marketPriceInput = document.getElementById("marketPrice");
            const labelLastSold = document.getElementById("labelLastSold");
            const labelAvgBuy = document.getElementById("labelAvgBuy");
            const themeToggle = document.getElementById("themeToggle");
            const toggleSearchBtn = document.getElementById("toggleSearch");
            const searchInput = document.getElementById("searchOrderNo");

            // === دالة تبديل الوضع ===
            function toggleTheme() {
                const body = document.body;
                const isLight = body.classList.contains("light-theme");
                if (isLight) {
                    body.classList.remove("light-theme");
                    body.classList.add("dark-theme");
                    themeToggle.textContent = "🌓 Light Mode";
                    localStorage.setItem("theme", "dark");
                } else {
                    body.classList.remove("dark-theme");
                    body.classList.add("light-theme");
                    themeToggle.textContent = "🌙 Dark Mode";
                    localStorage.setItem("theme", "light");
                }
            }

            // === تهيئة الوضع عند التحميل ===
            function initTheme() {
                const savedTheme = localStorage.getItem("theme");
                const body = document.body;

                // إذا لم يكن هناك اختيار محفوظ، اجعل الوضع الداكن هو الافتراضي
                if (savedTheme === "dark") {
                    body.classList.add("dark-theme");
                    themeToggle.textContent = "🌓 Light Mode";
                } else {
                    // الوضع الافتراضي = dark (حتى لو لم يُحفظ شيء)

                    body.classList.add("light-theme");
                    themeToggle.textContent = "🌙 Dark Mode";
                }
            }

            // === ملء عملات الـ Fiat ===
            function fillFiatOptions() {
                const t = translations[LANG];
                fiatCurrencySelect.innerHTML = "";
                Object.keys(t.currencies).forEach(code => {
                    const option = document.createElement("option");
                    option.value = code;
                    option.textContent = t.currencies[code];
                    fiatCurrencySelect.appendChild(option);
                });
            }

            // === تحديث الواجهة حسب اللغة ===
            function updateLang() {
                const t = translations[LANG];
                document.getElementById("title").textContent = t.title;
                const headers = document.querySelectorAll(".table-header > div");
                const cols = t.headers;
                headers.forEach((h, i) => {
                    if (i < 8) h.textContent = cols[i];
                });
                document.getElementById("showAll").textContent = t.all;
                document.getElementById("showBuys").textContent = t.buys;
                document.getElementById("showSells").textContent = t.sells;
                document.getElementById("printResults").textContent = t.print;
                document.getElementById("addManualTrade").textContent = t.addManual;
                document.getElementById("refresh").textContent = t.refresh;
                marketPriceInput.placeholder = t.marketPrice;
                labelLastSold.textContent = t.lastSold;
                labelAvgBuy.textContent = t.avgBuy;
                fillFiatOptions();
                renderTrades();
                renderResults();
                updateSearchLang();
            }

            // === زر البحث وتصفية حسب Order No. ===
            function updateSearchLang() {
                const t = translations[LANG];
                toggleSearchBtn.textContent = "🔍 " + t.search;
                searchInput.placeholder = t.searchPlaceholder;
            }

            function filterTrades() {
                const filterValue = searchInput.value.trim().toLowerCase();
                const rows = document.querySelectorAll(".trade-row");

                rows.forEach(row => {
                    const orderNoCell = row.querySelector(".col-number");
                    const orderNoText = orderNoCell ? orderNoCell.textContent.trim().toLowerCase() : "";

                    if (!filterValue || orderNoText.includes(filterValue)) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                });
            }

            toggleSearchBtn.addEventListener("click", () => {
                const isHidden = searchInput.style.display === "none";
                searchInput.style.display = isHidden ? "inline-block" : "none";
                searchInput.value = "";
                filterTrades();
                if (isHidden) {
                    searchInput.focus();
                }
                const t = translations[LANG];
                toggleSearchBtn.textContent = isHidden ? "❌ " + t.close : "🔍 " + t.search;
            });

            searchInput.addEventListener("input", filterTrades);

            // === أزرار العرض ===
            document.getElementById("showAll").addEventListener("click", () => setView("all"));
            document.getElementById("showBuys").addEventListener("click", () => setView("buys"));
            document.getElementById("showSells").addEventListener("click", () => setView("sells"));

            function setView(mode) {
                viewMode = mode;
                document.getElementById("showAll").classList.toggle("active", mode === "all");
                document.getElementById("showBuys").classList.toggle("active", mode === "buys");
                document.getElementById("showSells").classList.toggle("active", mode === "sells");
                renderTrades();
            }

            // === فرز الجدول ===
            document.querySelectorAll(".sortable").forEach(header => {
                header.addEventListener("click", () => {
                    const key = header.dataset.sort;
                    if (sortKey === key) {
                        sortDirection *= -1;
                    } else {
                        sortKey = key;
                        sortDirection = 1;
                    }
                    tradeList.sort((a, b) => {
                        let va = a[key],
                            vb = b[key];
                        if (["id", "price", "profit", "orderNo"].includes(key)) {
                            va = parseFloat(va) || 0;
                            vb = parseFloat(vb) || 0;
                        } else if (key === "time") {
                            va = new Date(va).getTime();
                            vb = new Date(vb).getTime();
                        } else {
                            va = String(va).toLowerCase();
                            vb = String(vb).toLowerCase();
                        }
                        return (va < vb ? -1 : va > vb ? 1 : 0) * sortDirection;
                    });
                    renderTrades();
                });
            });

            // === تحليل CSV ===
            function parseCSV(text) {
                const lines = text.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    headers.forEach((h, idx) => {
                        row[h] = values[idx] || '';
                    });
                    data.push(row);
                }
                return data;
            }

            // === الحساب الرئيسي ===
            function calculate(data) {
                const asset = assetCurrencySelect.value;
                const fiat = fiatCurrencySelect.value;
                const completed = data.filter(r => (r.Status || '').toLowerCase() === 'completed');
                const filtered = completed.filter(r => (r['Asset Type'] || '') === asset && (r['Fiat Type'] || '') === fiat);
                const sorted = filtered.sort((a, b) => new Date(a['Created Time']) - new Date(b['Created Time']));
                const inventory = [];
                let totalProfit = 0;
                let buyCount = 0,
                    sellCount = 0;
                let totalFees = 0;
                const tradeDetails = [];
                let lastSoldPrice = 0;
                for (const row of sorted) {
                    const price = parseFloat(row.Price) || 0;
                    const qty = parseFloat(row.Quantity) || 0;
                    const orderType = (row['Order Type'] || '').toLowerCase();
                    const orderNo = row['Order Number'] || '';
                    const counterparty = row['Couterparty'] || row['Counterparty'] || '';
                    let fee = 0;
                    if (row['Maker Fee']) fee += parseFloat(row['Maker Fee']) || 0;
                    if (row['Taker Fee']) fee += parseFloat(row['Taker Fee']) || 0;
                    totalFees += fee;
                    if (orderType === 'buy') {
                        buyCount++;
                        inventory.push([price, qty]);
                    } else if (orderType === 'sell') {
                        sellCount++;
                        let qtyToSell = qty;
                        let sellProfit = 0;
                        lastSoldPrice = price;
                        while (qtyToSell > 0 && inventory.length > 0) {
                            const [buyPrice, buyQty] = inventory[0];
                            const bQty = parseFloat(buyQty);
                            if (bQty <= qtyToSell + 1e-12) {
                                sellProfit += (price - buyPrice) * bQty;
                                qtyToSell -= bQty;
                                inventory.shift();
                            } else {
                                sellProfit += (price - buyPrice) * qtyToSell;
                                inventory[0][1] = bQty - qtyToSell;
                                qtyToSell = 0;
                            }
                        }
                        const netProfit = sellProfit - fee;
                        totalProfit += netProfit;
                        tradeDetails.push({
                            id: tradeDetails.length + 1,
                            time: row['Created Time'],
                            order: `Sell ${qty.toFixed(4)} ${asset}`,
                            price: price.toFixed(6),
                            profit: netProfit.toFixed(2),
                            orderNo,
                            counterparty,
                            type: 'sell',
                            manual: !!row.manual
                        });
                    }
                }
                inventory.forEach(([price, qty]) => {
                    tradeDetails.push({
                        id: tradeDetails.length + 1,
                        time: "N/A",
                        order: `Buy ${qty.toFixed(4)} ${asset}`,
                        price: price.toFixed(6),
                        profit: "—",
                        orderNo: "N/A",
                        counterparty: "N/A",
                        type: 'buy',
                        manual: false
                    });
                });
                const totalBuys = inventory.reduce((sum, [p, q]) => sum + p * q, 0);
                const totalSells = tradeDetails
                    .filter(t => t.type === 'sell')
                    .reduce((sum, t) => sum + parseFloat(t.price) * parseFloat(t.order.split(' ')[1]), 0);
                const remainingQty = inventory.reduce((sum, [p, q]) => sum + q, 0);
                const avgBuyPrice = remainingQty > 0 ? (totalBuys / remainingQty).toFixed(6) : "0.000000";
                const marketPrice = marketPriceInput.value && !isNaN(marketPriceInput.value) ?
                    parseFloat(marketPriceInput.value) : lastSoldPrice || 0;
                const marketValue = remainingQty * marketPrice;
                const unrealized = marketValue - totalBuys;
                document.getElementById("lastSoldPrice").textContent = lastSoldPrice.toFixed(6);
                document.getElementById("avgBuyPrice").textContent = avgBuyPrice;
                summaryValues = [
                    totalProfit.toFixed(2),
                    totalBuys.toFixed(2),
                    totalSells.toFixed(2),
                    totalFees.toFixed(2),
                    totalProfit.toFixed(2),
                    buyCount,
                    sellCount,
                    remainingQty.toFixed(6),
                    totalBuys.toFixed(2),
                    marketValue.toFixed(2),
                    unrealized.toFixed(2)
                ];
                return tradeDetails;
            }

            // === عرض الصفقات ===
            function renderTrades() {
                const body = document.getElementById("tableBody");
                body.innerHTML = "";
                let filtered = tradeList;
                if (viewMode === "buys") filtered = tradeList.filter(t => t.type === 'buy');
                else if (viewMode === "sells") filtered = tradeList.filter(t => t.type === 'sell');
                filtered.forEach(trade => {
                    const row = document.createElement("div");
                    row.className = `trade-row ${trade.manual ? 'manual-trade' : ''}`;
                    row.innerHTML = `
                        <div class="col-id">${trade.id}</div>
                        <div class="col-time">${trade.time}</div>
                        <div class="col-order order">${trade.order}</div>
                        <div class="col-price price">${trade.price}</div>
                        <div class="col-profit profit">${trade.profit}</div>
                        <div class="col-number">${trade.orderNo}</div>
                        <div class="col-counter">${trade.counterparty}</div>
                        <div class="col-delete">
                            <button class="delete-btn" onclick="deleteTrade('${trade.orderNo}', ${!!trade.manual})">🗑️</button>
                        </div>
                    `;
                    body.appendChild(row);
                });
                if (searchInput.style.display !== "none") {
                    filterTrades();
                }
            }

            // === حذف صفقة ===
            window.deleteTrade = function(orderNo, isManual) {
                originalData = originalData.filter(row => (row['Order Number'] || '') !== orderNo);
                refresh();
            };

            // === إضافة صفقة يدوية ===
            function addManualTrade() {
                const asset = assetCurrencySelect.value;
                const fiat = fiatCurrencySelect.value;
                const orderType = document.getElementById("manualOrderType").value;
                const price = parseFloat(document.getElementById("manualPrice").value) || 0;
                const qty = parseFloat(document.getElementById("manualQty").value) || 0;
                const counterparty = document.getElementById("manualCounterparty").value || "Manual";
                const orderNo = document.getElementById("manualOrderNo").value || `MANUAL-${Date.now()}`;
                const time = document.getElementById("manualTime").value || new Date().toISOString().slice(0, 19).replace('T', ' ');
                const newTrade = {
                    "Status": "Completed",
                    "Order Type": orderType.charAt(0).toUpperCase() + orderType.slice(1),
                    "Price": price,
                    "Quantity": qty,
                    "Asset Type": asset,
                    "Fiat Type": fiat,
                    "Order Number": orderNo,
                    "Counterparty": counterparty,
                    "Created Time": time,
                    "Maker Fee": "0",
                    "Taker Fee": "0",
                    manual: true
                };
                originalData.push(newTrade);
                refresh();
            }

            // === عرض النتائج ===
            function renderResults() {
                const grid = document.getElementById("resultsGrid");
                grid.innerHTML = "";
                const t = translations[LANG];
                t.labels.forEach((label, i) => {
                    const card = document.createElement("div");
                    card.className = "result-card";
                    card.innerHTML = `<div class="result-label">${label}</div><div class="result-value">${summaryValues[i]}</div>`;
                    grid.appendChild(card);
                });
            }

            // === تحميل ملف ===
            document.getElementById("loadFile").addEventListener("click", () => {
                const input = document.createElement("input");
                input.type = "file";
                input.accept = ".csv,.txt";
                input.style.display = "none";
                document.body.appendChild(input);
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return alert("No file selected.");
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const text = e.target.result;
                            const data = parseCSV(text);
                            originalData = data;
                            refresh();
                        } catch (err) {
                            alert("Error: " + err.message);
                        } finally {
                            document.body.removeChild(input);
                        }
                    };
                    reader.onerror = () => alert("Failed to read file.");
                    reader.readAsText(file);
                };
                input.click();
            });

            // === زر التحديث ===
            document.getElementById("refresh").addEventListener("click", refresh);

            function refresh() {
                if (originalData.length === 0) return;
                tradeList = calculate(originalData);
                renderTrades();
                renderResults();
            }

            // === طباعة النتائج ===
            document.getElementById("printResults").addEventListener("click", () => {
                const printWindow = window.open('', '_blank');
                const results = document.getElementById("resultsGrid").innerHTML;
                const additional = document.querySelector(".results-grid.bottom").outerHTML;
                const title = document.getElementById("title").textContent;
                printWindow.document.write(`
                    <html>
                    <head><title>Print Results</title>
                    <style>
                        body { font-family: Arial, sans-serif; background: white; color: black; padding: 20px; }
                        .result-card { background: #f0f0f0; padding: 10px; margin: 10px; border-radius: 8px; text-align: center; }
                        .result-label { font-weight: bold; color: #333; }
                        .result-value { font-size: 18px; color: #000; }
                    </style>
                    </head>
                    <body>
                        <h1>${title}</h1>
                        <div class="results-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;">
                            ${results}
                        </div>
                        ${additional}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => printWindow.print(), 500);
            });

            // === ربط الأحداث ===
            document.getElementById("addManualTrade").addEventListener("click", addManualTrade);
            marketPriceInput.addEventListener("input", () => refresh());
            themeToggle.addEventListener("click", toggleTheme);
            document.getElementById("language").addEventListener("change", (e) => {
                LANG = e.target.value;
                updateLang();
                updateSearchLang();
            });

            // === التهيئة النهائية ===
            initTheme();
            updateLang();
            setView("all");
            updateSearchLang();
        });
    </script>
</body>


</html>
google-site-verification=1jtE_UmafXwduCLCB9v94c2c0HbtGan4qssyh3mHjcQ
